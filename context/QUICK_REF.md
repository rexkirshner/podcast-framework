# Quick Reference

**Auto-generated by `/save-context`** - Do not edit manually

---

## Project: Strange Water Podcast Website

**Current:** Phase 2c | **Session:** 17 | **Progress:** Production Live, Hosting Analysis Complete, Ready for Abstraction Refactor

## Tech Stack

- **Framework:** Astro 5.1.4 (SSG, TypeScript strict mode)
- **CMS:** Sanity.io (project ID: ej6443ov, dataset: production)
- **Hosting:** Netlify (auto-deploy on git push)
- **Styling:** Tailwind CSS v4 + CMS-driven theming
- **Language:** TypeScript (strict mode)
- **Email:** Resend (contribution@noreply.strangewater.xyz verified)
- **Analytics:** Google Analytics 4
- **Serverless Functions:** 2 functions (newsletter-subscribe, contribute)

## URLs

- **Production:** https://strangewater.xyz ✅ LIVE
- **Staging:** ~~https://staging.strangewater.xyz~~ (decommissioned)
- **Local (Astro):** http://localhost:4321/
- **Local (Sanity):** http://localhost:3333/
- **Repository:** https://github.com/rexkirshner/podcast-framework

## Current Focus

**Phase:** Phase 2c - Production Operations & Hosting Portability

**Active Task:** Context checkpoint complete, ready for hosting abstraction refactor Sprint 1

**Next Priorities:**
1. **Git commit** Session 17 changes (contribute fix, hosting analysis, context updates) - **DO NOT PUSH**
2. **Review hosting migration analysis** (`context/tasks/hosting-migration-analysis.md`)
3. **Begin Sprint 1 refactor:** Extract business logic to `src/server/` (12-16 hours)
4. Add unit tests for extracted services (newsletter, contribution)

## Quick Commands

```bash
# Development
npm run dev                    # Start Astro dev server (localhost:4321)
npm run sanity                 # Start Sanity Studio (localhost:3333)
npm run build                  # Build for production (146 pages, 30s)
npm test                       # Run all tests (40 passing)

# Content Management
node scripts/import-episodes.js     # Import episodes from Anchor RSS
node scripts/link-guests.js         # Auto-link guests to episodes
node scripts/update-durations.js    # Fix episode durations

# Netlify Functions (serverless)
netlify dev                    # Test functions locally (NOT npm run dev)

# Context System
/save-context                  # Update all context docs + commit
/code-review                   # Run comprehensive code audit
/review-context                # Validate context system integrity
```

## Project Status

**Production:** ✅ Live at strangewater.xyz
**Build Status:** ✅ 146 pages, zero errors, 30s build time
**Code Quality:** A+ (96-98%, all issues resolved)
**Community Features:** ✅ Contribution form fully functional
**Vendor Lock-in:** 6/10 (moderate - will reduce to 3/10 after abstraction)

## Critical Protocols

⚠️ **GIT PUSH PERMISSION:** NEVER push to GitHub without explicit user permission (triggers Netlify build, consumes quota)

## Recent Work (Session 17)

**Accomplished:**
- ✅ Site migrated to production domain (strangewater.xyz)
- ✅ Fixed contribute button serverless compatibility (DOMPurify → escapeHTML)
- ✅ Created comprehensive hosting migration analysis (2,290 lines)
- ✅ Documented git push protocol violation #3 with solutions
- ✅ Selected abstraction strategy: Option A (reduce lock-in 74%)

**Files Changed:**
- `netlify/functions/contribute.ts` - Serverless compatibility fix
- `context/tasks/hosting-migration-analysis.md` - NEW (2,290 lines)
- `context/claude-context-feedback.md` - Git push protocol analysis
- `context/SESSIONS.md` - Session 17 comprehensive entry
- `context/STATUS.md` - Updated current state

**Ready to Commit:** All Session 17 changes staged, awaiting commit (NOT push)

## Hosting Abstraction Roadmap

- [x] **Phase 0:** Analyze dependencies, create strategy (✅ Complete - Session 17)
- [ ] **Sprint 1:** Extract business logic to `src/server/` (12-16 hours) ← NEXT
- [ ] **Sprint 2:** Add provider adapter pattern (8-12 hours)
- [ ] **Phase 3:** Replace in-memory rate limiting with Upstash Redis (6-8 hours)
- [ ] **Phase 4:** Abstract configuration management (4-6 hours)

**Goal:** Reduce vendor lock-in from 6/10 → 3/10, cut migration effort from 31 hours → 8 hours (74% reduction)

## Hosting Providers Comparison

| Provider | Cost | Bandwidth | Lock-in | Migration Effort |
|----------|------|-----------|---------|------------------|
| **Netlify (current)** | $0/mo | 100 GB | 6/10 | N/A |
| **Cloudflare Pages** | $0/mo | ∞ Unlimited | 5/10 | 16-24 hrs (after abstraction: 8 hrs) |
| **Vercel** | $20/mo | 100 GB | 7/10 | 20-32 hrs (after abstraction: 8 hrs) |
| **AWS Amplify** | ~$5-10/mo | ~5K visits | 8/10 | 40-60 hrs (no official adapter) |

**Recommendation:** Implement abstraction layer first, then decide on migration based on traffic growth.

## Content Stats

- **Episodes:** 69 (all with metadata, durations, Spotify embeds)
- **Guests:** 72 (65 with profile photos)
- **Episode Covers:** 66/68 uploaded
- **Guest-Episode Links:** 63/67 auto-linked
- **Build Output:** 146 static pages

## Key Files

- **Context Entry Point:** `context/CONTEXT.md`
- **Current Status:** `context/STATUS.md` (this summary's source)
- **Session History:** `context/SESSIONS.md`
- **Decision Log:** `context/DECISIONS.md`
- **Hosting Analysis:** `context/tasks/hosting-migration-analysis.md`
- **Git Protocol Feedback:** `context/claude-context-feedback.md`

## Known Issues

**None** - All production issues resolved:
- ✅ Contribute button fixed (serverless compatibility)
- ✅ DNS migration complete
- ✅ Email notifications working

## Next Session Plan

1. **Commit Session 17 changes** (NOT push to GitHub)
2. **Create `src/server/` directory structure**
   - `services/` - Business logic (newsletter, contribution)
   - `adapters/` - Provider interfaces (will add in Sprint 2)
   - `utils/` - Shared utilities
3. **Extract newsletter service:**
   - Create `src/server/services/newsletter-service.ts`
   - Move ConvertKit logic from `netlify/functions/newsletter-subscribe.ts`
   - Add unit tests (vitest)
4. **Extract contribution service:**
   - Create `src/server/services/contribution-service.ts`
   - Move Sanity/Resend logic from `netlify/functions/contribute.ts`
   - Add unit tests (vitest)
5. **Update Netlify functions to thin wrappers**
6. **Deploy and verify** (build succeeds, all forms work)

**Estimated Time:** 12-16 hours (Sprint 1)
**Goal:** Portable business logic, reduced lock-in to 4/10
