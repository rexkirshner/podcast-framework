---
import { stripHTML } from "../lib/utils";
import { getPodcastInfo } from "../lib/sanity";
import { getTheme, defaultTheme } from "../lib/theme";
import type { Episode } from "../lib/sanity";

interface Props {
  episodes: Episode[];
}

const { episodes } = Astro.props;
const podcastInfo = await getPodcastInfo();
const theme = (await getTheme()) || defaultTheme;
---

{episodes.length > 0 && (
  <section style="background: var(--color-surface);" class="py-12">
    <div class="max-w-5xl mx-auto px-4">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-bold" style="color: var(--color-text);">Featured Episodes</h2>
        <div class="flex gap-2">
          <button
            id="carousel-prev"
            style="background: var(--color-background);"
            class={`p-2 ${theme.layout.borderRadius} shadow-md hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed`}
            aria-label="Previous episode"
          >
            <svg class="w-6 h-6" style="color: var(--color-text);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <button
            id="carousel-next"
            style="background: var(--color-background);"
            class={`p-2 ${theme.layout.borderRadius} shadow-md hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed`}
            aria-label="Next episode"
          >
            <svg class="w-6 h-6" style="color: var(--color-text);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>

      <div
        class="relative overflow-hidden"
        role="region"
        aria-label="Featured Episodes Carousel"
      >
        <div
          id="carousel-container"
          class="flex transition-transform duration-500 ease-in-out"
          role="list"
          aria-live="polite"
        >
          {episodes.map((episode, index) => (
            <a
              href={`/episodes/${episode.slug.current}`}
              style="background: var(--color-surface); border: 1px solid rgba(0, 163, 181, 0.3);"
              class={`flex-shrink-0 w-full ${theme.layout.borderRadius} shadow-lg hover:shadow-2xl hover:border-opacity-70 transition group`}
              role="listitem"
              aria-posinset={index + 1}
              aria-setsize={episodes.length}
              aria-label={`Episode ${episode.episodeNumber}: ${episode.title}`}
            >
              <div class="flex flex-col md:flex-row gap-6 p-6">
                <!-- Episode Image -->
                <div class="flex-shrink-0">
                  {episode.coverImage?.url ? (
                    <img
                      src={episode.coverImage.url}
                      alt={episode.title}
                      class={`w-full md:w-64 h-64 object-cover ${theme.layout.borderRadius} group-hover:scale-105 transition-transform duration-300`}
                      loading="lazy"
                    />
                  ) : podcastInfo?.logo?.url ? (
                    <img
                      src={podcastInfo.logo.url}
                      alt={podcastInfo.name}
                      class={`w-full md:w-64 h-64 object-cover ${theme.layout.borderRadius} group-hover:scale-105 transition-transform duration-300`}
                      loading="lazy"
                    />
                  ) : (
                    <div style="background: var(--color-surface);" class={`w-full md:w-64 h-64 ${theme.layout.borderRadius} flex items-center justify-center`}>
                      <span class="text-5xl font-bold" style="color: var(--color-primary);">{episode.episodeNumber}</span>
                    </div>
                  )}
                </div>

                <!-- Episode Content -->
                <div class="flex-grow flex flex-col">
                  <p class="text-sm uppercase tracking-wide mb-2" style="color: var(--color-primary);">
                    Episode {episode.episodeNumber}
                  </p>
                  <h3 class="text-2xl font-semibold group-hover:opacity-80 transition-opacity mb-4" style="color: var(--color-text);">
                    {episode.title}
                  </h3>

                  <!-- Host and Guests -->
                  <div class="mb-4">
                    {podcastInfo?.host && (
                      <p class="text-sm mb-2" style="color: var(--color-text-muted);">
                        <span class="font-semibold">Host:</span> {podcastInfo.host}
                      </p>
                    )}
                    {episode.guests && episode.guests.length > 0 && (
                      <p class="text-sm" style="color: var(--color-text-muted);">
                        <span class="font-semibold">Guests:</span> {episode.guests.map(g => g.name).join(", ")}
                      </p>
                    )}
                  </div>

                  <!-- Description -->
                  {episode.description && (
                    <p class="leading-relaxed line-clamp-4" style="color: var(--color-text-muted);">
                      {stripHTML(episode.description)}
                    </p>
                  )}
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>

      <!-- Dots indicator -->
      <div class="flex justify-center gap-2 mt-6">
        {episodes.map((_, index) => (
          <button
            style="background: var(--color-text-muted); opacity: 0.5;"
            class={`carousel-dot w-2 h-2 ${theme.layout.borderRadius} transition-all hover:opacity-100`}
            data-index={index}
            aria-label={`Go to episode ${index + 1}`}
          />
        ))}
      </div>
    </div>
  </section>
)}

<script>
  import { initCarousel } from '../scripts/carousel';

  // Initialize carousel with auto-progression
  initCarousel();
</script>
