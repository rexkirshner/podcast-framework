---
// Dynamic episode page - fetches from Sanity based on slug
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { SITE_CONFIG } from "../../config/site";
import "../../styles/global.css";
import { getAllEpisodes, getEpisodeBySlug, getPodcastInfo } from "../../lib/sanity";
import type { Episode } from "../../lib/sanity";

// Generate static paths for all episodes at build time
export async function getStaticPaths() {
  const episodes = await getAllEpisodes();

  return episodes.map((episode) => ({
    params: { slug: episode.slug.current },
    props: { episode },
  }));
}

// Get episode from props (passed from getStaticPaths)
const { episode } = Astro.props as { episode: Episode };

// Fetch podcast info for isActive status
const podcastInfo = await getPodcastInfo();

// Format date helper
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Determine which Spotify embed to use
const spotifyEmbedUrl = episode.spotifyEpisodeId
  ? `https://open.spotify.com/embed/episode/${episode.spotifyEpisodeId}?utm_source=generator`
  : `https://open.spotify.com/embed/show/${SITE_CONFIG.spotifyShowId}?utm_source=generator`;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{episode.title} - {SITE_CONFIG.name}</title>
    <meta name="description" content={episode.description.substring(0, 160)} />
  </head>
  <body class="bg-gray-50 text-gray-900 flex flex-col min-h-screen">
    <Header />

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-12 flex-grow">
      <!-- Episode Header -->
      <div class="mb-8">
        <p class="text-sm text-gray-500 uppercase tracking-wide mb-2">
          Episode {episode.episodeNumber}
        </p>
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
          {episode.title}
        </h1>
        <div class="flex gap-4 text-sm text-gray-600">
          <span>{formatDate(episode.publishDate)}</span>
          {episode.duration && (
            <>
              <span>â€¢</span>
              <span>{episode.duration}</span>
            </>
          )}
        </div>
      </div>

      <!-- Guests Section (if any) -->
      {episode.guests && episode.guests.length > 0 && (
        <div class="mb-8">
          <h2 class="text-lg font-semibold mb-3">Guests</h2>
          <div class="flex flex-wrap gap-4">
            {episode.guests.map((guest) => (
              <div class="flex items-center gap-3 bg-white rounded-lg p-3 shadow-sm">
                {guest.photo?.url && (
                  <img
                    src={guest.photo.url}
                    alt={guest.name}
                    class="w-12 h-12 rounded-full object-cover"
                  />
                )}
                <div>
                  <p class="font-semibold text-gray-900">{guest.name}</p>
                  {(guest.twitter || guest.website || guest.linkedin) && (
                    <div class="flex gap-2 mt-1">
                      {guest.twitter && (
                        <a
                          href={`https://twitter.com/${guest.twitter}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-xs text-blue-600 hover:text-blue-800"
                        >
                          @{guest.twitter}
                        </a>
                      )}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Audio Player Section -->
      <div class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <iframe
          style="border-radius:12px"
          src={spotifyEmbedUrl}
          width="100%"
          height="232"
          frameBorder="0"
          allowfullscreen=""
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy"
        ></iframe>
      </div>

      <!-- Episode Description -->
      <div class="mb-12">
        <h2 class="text-2xl font-semibold mb-4">About This Episode</h2>
        <p class="text-gray-700 leading-relaxed whitespace-pre-line">
          {episode.description}
        </p>
      </div>

      <!-- Show Notes (if available) -->
      {episode.showNotes && episode.showNotes.length > 0 && (
        <div class="mb-12">
          <h2 class="text-2xl font-semibold mb-4">Show Notes</h2>
          <div class="prose prose-blue max-w-none">
            {/* Render Sanity block content - simplified version */}
            {episode.showNotes.map((block: any) => {
              if (block._type === 'block') {
                return (
                  <p class="text-gray-700 mb-4">
                    {block.children?.map((child: any) => child.text).join('')}
                  </p>
                );
              }
              return null;
            })}
          </div>
        </div>
      )}

      <!-- Subscribe or Listen CTA -->
      <div class="bg-blue-50 rounded-lg p-6 text-center">
        {podcastInfo?.isActive ? (
          <>
            <h3 class="text-xl font-semibold mb-2">Subscribe to {SITE_CONFIG.name}</h3>
            <p class="text-gray-600 mb-4">
              Get notified when new episodes are released
            </p>
          </>
        ) : (
          <>
            <h3 class="text-xl font-semibold mb-2">Listen to {SITE_CONFIG.name}</h3>
            <p class="text-gray-600 mb-4">
              Explore the complete archive on your favorite platform
            </p>
          </>
        )}
        <div class="flex gap-4 justify-center">
          <a
            href={SITE_CONFIG.links.spotify}
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
            target="_blank"
            rel="noopener noreferrer"
          >
            Spotify
          </a>
          <a
            href={SITE_CONFIG.links.apple}
            class="px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition"
            target="_blank"
            rel="noopener noreferrer"
          >
            Apple Podcasts
          </a>
        </div>
      </div>
    </main>

    <Footer />
  </body>
</html>
