---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getAllEpisodes, getPodcastInfo } from "../lib/sanity";
import { formatDate, stripHTML } from "../lib/utils";

// Fetch latest episode and podcast info
const episodes = await getAllEpisodes();
const latestEpisode = episodes[0]; // Episodes are already sorted by episodeNumber desc
const podcastInfo = await getPodcastInfo();

// Use podcast info from CMS
const siteName = podcastInfo?.name || "Podcast";
const siteTagline = podcastInfo?.tagline || "";
const siteDescription = podcastInfo?.description || "";
const spotifyUrl = podcastInfo?.spotifyUrl || "#";
---

<BaseLayout
	title={`${siteName}${siteTagline ? ` - ${siteTagline}` : ""}`}
	description={siteDescription}
>
	<main class="flex-grow">
			<!-- Hero Section -->
			<section class="bg-gradient-to-br from-blue-600 to-blue-800 text-white py-20">
				<div class="max-w-4xl mx-auto px-4 text-center">
					<h1 class="text-5xl font-bold mb-4">{siteName}</h1>
					<p class="text-xl text-blue-100 mb-8">
						{siteDescription}
					</p>
					<div class="flex gap-4 justify-center">
						{spotifyUrl && spotifyUrl !== "#" && (
							<a
								href={spotifyUrl}
								class="px-6 py-3 bg-white text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition"
								target="_blank"
								rel="noopener noreferrer"
							>
								Listen on Spotify
							</a>
						)}
						{latestEpisode && (
							<a
								href={`/episodes/${latestEpisode.slug.current}`}
								class="px-6 py-3 bg-blue-700 text-white rounded-lg font-semibold hover:bg-blue-600 transition border border-blue-400"
							>
								Latest Episode
							</a>
						)}
					</div>
				</div>
			</section>

			<!-- Latest Episode Section -->
			{latestEpisode && (
				<section class="max-w-4xl mx-auto px-4 py-16">
					<h2 class="text-3xl font-bold mb-8">Latest Episode</h2>
					<a
						href={`/episodes/${latestEpisode.slug.current}`}
						class="block bg-white rounded-lg shadow-md hover:shadow-lg transition p-6"
					>
						<div class="flex items-start gap-4">
							{latestEpisode.coverImage?.url ? (
								<img
									src={latestEpisode.coverImage.url}
									alt={latestEpisode.title}
									class="flex-shrink-0 w-24 h-24 rounded-lg object-cover"
								/>
							) : podcastInfo?.logo?.url ? (
								<img
									src={podcastInfo.logo.url}
									alt={siteName}
									class="flex-shrink-0 w-24 h-24 rounded-lg object-cover"
								/>
							) : (
								<div class="flex-shrink-0 w-24 h-24 bg-blue-100 rounded-lg flex items-center justify-center">
									<span class="text-3xl font-bold text-blue-600">{latestEpisode.episodeNumber}</span>
								</div>
							)}
							<div class="flex-grow">
								<p class="text-sm text-gray-500 uppercase tracking-wide mb-1">
									Episode {latestEpisode.episodeNumber}
								</p>
								<h3 class="text-xl font-semibold text-gray-900 mb-2">
									{latestEpisode.title}
								</h3>
								<p class="text-gray-600 mb-3">
									{stripHTML(latestEpisode.description).substring(0, 150)}...
								</p>
								<div class="flex gap-4 text-sm text-gray-500">
									<span>{formatDate(latestEpisode.publishDate)}</span>
									{latestEpisode.duration && (
										<>
											<span>â€¢</span>
											<span>{latestEpisode.duration}</span>
										</>
									)}
								</div>
							</div>
						</div>
					</a>
				</section>
			)}

		<!-- About Section -->
		<section class="bg-white py-16">
			<div class="max-w-4xl mx-auto px-4">
				<h2 class="text-3xl font-bold mb-6">About the Show</h2>
				{siteDescription && (
					<p class="text-lg text-gray-700 leading-relaxed mb-4">
						{siteDescription}
					</p>
				)}
				<p class="text-lg text-gray-700 leading-relaxed">
					Each episode dives into the topics and conversations that matter most
					to our community, bringing you insights and perspectives from across
					the ecosystem.
				</p>
			</div>
		</section>
	</main>
</BaseLayout>
